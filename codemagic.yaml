# codemagic.yaml
# Workflow para compilar la app Voces de Esperanza (Gatsby + Capacitor) - VERSIÓN CORREGIDA

workflows:
  # --- WORKFLOW PARA ANDROID (CORREGIDO) ---
  android-build:
    name: VDE Android Build
    instance_type: mac_mini_m1
    environment:
      java: 21
      groups:
        # Esto importa correctamente TODAS las variables que creaste en la UI
        - keystore_credentials
        - contentful_credentials
      vars:
        # Solo definimos las variables que no son secretas
        PACKAGE_NAME: "com.vocesdeesperanza.app"
    scripts:
      - name: Instalar dependencias
        script: | 
          npm install
      - name: Construir el sitio Gatsby
        script: | 
          npm run build
      - name: Sincronizar con Capacitor y actualizar Android
        script: | 
          npx cap sync android
          npx cap update android
      
      # --- PASO NUEVO Y CRUCIAL ---
      - name: Decodificar y guardar el Keystore
        script: | 
          echo $CM_KEYSTORE | base64 --decode > /tmp/keystore.keystore
          
      - name: Construir APK de Android
        script: | 
          cd android
          # PASO CRUCIAL: Damos permisos de ejecución al script de Gradle
          chmod +x ./gradlew 
          # Ahora sí, el comando funcionará sin problemas
          ./gradlew assembleRelease 
    artifacts:
      - android/app/build/outputs/**/*.apk


   # --- WORKFLOW PARA iOS (SOLUCIÓN FINAL DE CLAUDE #2) ---
  ios-build:
    name: VDE iOS Build
    instance_type: mac_mini_m1
    integrations:
      app_store_connect: VDE_AppStoreConnect
    environment:
      groups:
        - app_store_connect_credentials
        - contentful_credentials
        - ios_signing_credentials
      vars:
        XCODE_TEAM_ID: AKKP464BSH
        KEYCHAIN_PATH: $CM_KEYCHAIN_PATH
        KEYCHAIN_PASSWORD: $CM_KEYCHAIN_PASSWORD
    scripts:
      - name: Instalar dependencias
        script: | 
          npm install
      - name: Instalar dependencias de iOS (Cocoapods)
        script: | 
          cd ios/App && pod install
      - name: Construir el sitio Gatsby
        script: | 
          npm run build
      - name: Sincronizar con Capacitor y actualizar iOS
        script: | 
          npx cap sync ios
          npx cap update ios
      - name: Configurar Llavero y Perfil de Aprovisionamiento
        script: |
          set -ex
          echo $CERTIFICATE_P12_BASE64 | base64 --decode > /tmp/certificate.p12
          
          # Create keychain with a simpler path
          KEYCHAIN_PATH="$HOME/Library/Keychains/temp.keychain"
          KEYCHAIN_PASSWORD="temp_password_123"
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -l "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import /tmp/certificate.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | sed s/\"//g)
          
          # Export for later use
          echo "export KEYCHAIN_PATH=\"$KEYCHAIN_PATH\"" >> $CM_ENV
          echo "export KEYCHAIN_PASSWORD=\"$KEYCHAIN_PASSWORD\"" >> $CM_ENV
          
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles
          mkdir -p "$PROFILE_PATH"
          echo $PROVISIONING_PROFILE_BASE64 | base64 --decode > "$PROFILE_PATH/VDE_AppStore_Profile.mobileprovision"
          
      - name: Construir y Archivar (Firma Dirigida por SDK)
        script: | 
          set -ex
          # Source the environment to get keychain variables
          source $CM_ENV
          
          # First, properly configure the App target for manual signing using sed
          # Find and replace CODE_SIGN_STYLE = Automatic with Manual for the App target
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/App/App.xcodeproj/project.pbxproj
          
          # Also set the provisioning profile for the App target
          sed -i '' '/CODE_SIGN_STYLE = Manual;/a\
                PROVISIONING_PROFILE_SPECIFIER = "VDE AppStore Profile";' ios/App/App.xcodeproj/project.pbxproj
          
          # Unlock keychain before building
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Now build with the configured settings
          xcodebuild archive \
            -workspace "ios/App/App.xcworkspace" \
            -scheme "App" \
            -archivePath "$CM_BUILD_DIR/App.xcarchive" \
            -configuration Release \
            DEVELOPMENT_TEAM="$XCODE_TEAM_ID" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            OTHER_CODE_SIGN_FLAGS="--keychain \"$KEYCHAIN_PATH\""
            
      - name: Exportar el .ipa (Modo Manual)
        script: |
          set -ex
          # Create output directory if it doesn't exist
          mkdir -p "$CM_BUILD_DIR/output"
          
          xcodebuild -exportArchive \
            -archivePath "$CM_BUILD_DIR/App.xcarchive" \
            -exportPath "$CM_BUILD_DIR/output" \
            -exportOptionsPlist "export_options.plist"
    artifacts:
      - $CM_BUILD_DIR/output/*.ipa
    publishing:
      app_store_connect:
        # Use the correct variable names from your environment group
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true